<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
  <title>pvDatabase Record Support</title>
  <link rel="stylesheet" type="text/css"
  href="../../css/base.css" />
  <link rel="stylesheet" type="text/css"
  href="../../css/epicsv4.css" />
  <style type="text/css">
  /*<![CDATA[*/
     .about { margin-left: 3em; margin-right: 3em; font-size: .83em}
     table { margin-left: auto; margin-right: auto }
     .diagram { text-align: center; margin: 2.5em 0 }
     span.opt { color: grey }
     span.nterm { font-style:italic }
     span.term { font-family:courier }
     span.user { font-family:courier }
     span.user:before { content:"<" }
     span.user:after { content:">" }
     .nonnorm { font-style:italic }
     p.ed { color: #AA0000 }
     span.ed { color: #AA0000 }
     p.ed.priv { display: inline; }
     span.ed.priv { display: inline; }
  /*]]>*/</style>
  <!-- Script that generates the Table of Contents -->
  <script type="text/javascript"
  src="../../css/tocgen.js">
  </script>
</head>
<body>

<div class="head">
<h1>pvDatabase Record Support</h1>

<h2 class="nocount">editions</h2>
<dl>
  <dt>2019.09.11</dt>
     <dd>Original</dd>
  <dt>2012.04.09</dt>
     <dd>Update</dd>
</dl>
<dl>
  <dt>Original: 2019.09.11</dt>
   <dd>
   Original documentation.
   </dd>
  <dt>Revised: 2021.03.26</dt>
  <dd>
  Revised the documentation.
  </dd>
</dl>

<dl>
  <dt>Editors:</dt>
    <dd>Marty Kraimer</dd>
</dl>

<p>This product is available via an <a
href="../../LICENSE">open source license
</a></p>

</div>


<div id="toc">
<h2 class="nocount" style="page-break-before: always">Table of Contents</h2>
</div>
<div id="contents" class="contents">

<h2>Overview</h2>
<p>The following descibes support that can be attached to a PVRecord.
The support is called each time a record is processed.
</p>
<p>
<a href="https://github.com/epics-base/exampleCPP">exampleCPP</a>
has an example named <b>support</b>, which demonstrates use of the support
described in this document.
</p>
<p>
The next two sections describe the existing support.
Then follows a description of how to run the support example.
Finally there is a section about how to use the support in services
implemented via pvDatabase.
</p>
<p>
The last section describes <b>exampleCPP/support</b>
</p>
<h2>controlSupport</h2>
<p><b>controlSupport</b> is support for any field that is a numeric scalar.
The following must appear in the same structure as the field being supported:
</p>
<pre>
control_t control
    double limitLow
    double limitHigh
    double minStep
    scalarType outputValue
</pre>
where:
<dl>
  <dt>limitLow</dt>
    <dd>
     When the record is processed and the associated value field is modified,
     the new value is not allowed to be less than limitLow.
    </dd>
  <dt>limitHigh</dt>
    <dd>
     When the record is processed and the associated value field is modified,
     the new value is not allowed to be greater than limitHigh.
    </dd>
  <dt>minStep</dt>
    <dd>
    When to associated value field is changed then
    outputValue is not allowed to change by more then minStep
    each time the the record is processed.
    </dd> 
  <dt>outputValue</dt>
    <dd>
    The current output value. Note that it has the same scalarType as
     the associated value field.
    </dd>
</dl>
<b>NOTES:</b>
<ul>
   <li>
    The limits are ignored if <b>limitHigh&lt;=limitLow</b>
   </li>
   <li>
    minStep is ignored if <b>minStep&lt;=0</b>.
   </li>
</ul>
<h2>scalarAlarmSupport</h2>
<p><b>scalarAlarmSupport</b> is support for any field that is a numeric scalar.
The following must appear in the same structure as the field being supported:
</p>
<pre>
scalarAlarm_t scalarAlarm
    double lowAlarmLimit
    double lowWarningLimit
    double highWarningLimit
    double highAlarmLimit
    double hysteresis
</pre>
where:
<dl>
  <dt>lowAlarmLimit</dt>
    <dd>
     When the record is processed the associated value field is checked
     to see if it is less than lowAlarmLimit.
     If it is the alarm field is set to major alarm.
    </dd>
  <dt>lowWarningLimit</dt>
    <dd>
     When the record is processed the associated value field is checked
     to see if it is less than lowWarningLimit.
     If it is the alarm field is set to minor alarm.
    </dd>
  <dt>highWarningLimit</dt>
    <dd>
     When the record is processed the associated value field is checked
     to see if it is less than highWarningLimit.
     If it is the alarm field is set to minor alarm.
    </dd>
  <dt>highAlarmLimit</dt>
    <dd>
     When the record is processed the associated value field is checked
     to see if it is less than highAlarmLimit.
     If it is the alarm field is set to major alarm.
    </dd>
  <dt>hysteresis</dt>
    <dd>
    If an alarm is raised then it is not set to a lower alarm severity
    until the associated value changes from the current limit by at least
    <b>hysteresis</b>.
    </dd>
</dl>
<b>NOTES:</b>
<ul>
   <li>
   A field named <b>alarm</b> must exists in the same structure as the field being     
   supported and must be standard alarm field.
   </li>
   <li>
    The high limits are ignored if <b>highAlarmLimit&lt;=lowAlarmLimit</b>
   </li>
   <li>
    The warning limits are ignored if <b>highWarningLimit&lt;=lowWarningLimit</b>
   </li>
   <li>
    High limits are checked before warning limits.
   </li>
   <li>
    hysteresis is ignored if <b>hysteresis&lt;=0</b>.
   </li>
</ul>

<h2>exampleCPP/support</h2>
<p><b>NOTE:</b>
Support for control is defined by a combination of definitions in pvData and in pvDatabase.
I think the semantics are wrong.
I think two improvments should be made:
</p>
<dl>
   <dt>minStep</dt>
   <dd>
   This should be named <b>maxStep</b>.
   </dd>
   <dt>value</dt>
   <dd>
   This is what should be changed by maxStep each time the record is processed.
   </dd>
</dl>
<h3>Starting support</h3>
<p>To start the database for this example:</p>
<pre>
pwd
/home/epics7/modules/exampleCPP/support
bin/linux-x86_64/supportMain
</pre>
<p>
When the IOC is started it has the following records:
</p>
<pre>
PVRsupportDouble
PVRsupportProcessRecord
PVRsupportUByte
</pre>
<h4>supportRecordCreate</h4>
<p>This is an iocshell command implemented in exampleCPP/support.
It creates PVRecord instances that are used and described later in this tutorial.
The created record uses the <b>control</b> and <b>scalarAlarm</b> support from
pvDatabase.
</p>
<p>A created record has the following structure:</p>
<pre>
pvinfo PVRsupportDouble
PVRsupportDouble
Server: 10.0.0.9:5075
Type:
    structure
        double value
        boolean reset
        alarm_t alarm
            int severity
            int status
            string message
        time_t timeStamp
            long secondsPastEpoch
            int nanoseconds
            int userTag
        display_t display
            double limitLow
            double limitHigh
            string description
            string format
            string units
        control_t control
            double limitLow
            double limitHigh
            double minStep
            double outputValue
        scalarAlarm_t scalarAlarm
            double lowAlarmLimit
            double lowWarningLimit
            double highWarningLimit
            double highAlarmLimit
            double hysteresis
</pre>
example usage appears later in this tutorial.
<h3>Use configAll script to configure records</h3>
<p>Run the following:</p>
<pre>
pwd
/home/epicsv4/masterCPP/exampleCPP/support/client/scripts
./configAll
</pre>
<p>configAll does the following:</p>
<ul>
   <li>
    Sets control and scalarAlarm fields for both PVRsupportDouble and PVRsupportUByte.
   </li>
   <li>
    Asks PVRsupportProcessRecord to process PVRsupportDouble and PVRsupportUByte.
    <br />
    Thus each of these records will be periodically processed.
   </li>
</ul>
<h3>Run an example client</h3>
<h4>Look at the following</h4>
<pre>
pvget -r "control,scalarAlarm" PVRsupportDouble
PVRsupportDouble structure 
    control_t control
        double limitLow -10
        double limitHigh 10
        double minStep 0.5
        double outputValue 10
    scalarAlarm_t scalarAlarm
        double lowAlarmLimit -8
        double lowWarningLimit -6
        double highWarningLimit 6
        double highAlarmLimit 8
        double hysteresis 0.1
</pre>
<h4>In one window enter</h4>
<pre>
pvget -m -r "value,control.outputValue,alarm,timeStamp" -v PVRsupportDouble
</pre>
The output from this window will be described after you enter the next command.
<h4>Enter:</h4>
<pre>
pvput PVRsupportDouble  20
</pre>
<h4>Results</h4>
In the window where you issued pvget you will first see:
<pre>
PVRsupportDouble structure 
    double value 10
    structure control
        double outputValue 0.5
    alarm_t alarm MAJOR RECORD major high alarm 
        int severity 2
        int status 3
        string message major high alarm
    time_t timeStamp 2019-07-01 09:32:51.793  
        long secondsPastEpoch 1561987971
        int nanoseconds 792512003
</pre>
<p>
<b>value</b> only went to 10 because that is the control limit.
<b>alarm</b> shows the values determined by scalarAlarm .
<b>outputValue</b> is .5 because of minStep.
</p>
<p>Next you will see output like:</p>
<pre>
PVRsupportDouble structure 
    structure control
        double outputValue .5
    time_t timeStamp 2021-04-06 10:39:28.987
        int nanoseconds 968025553
</pre>
<p>This will continue until You see:</p>
<pre>
PVRsupportDouble structure 
    structure control
        double outputValue 10
    time_t timeStamp  2021-04-06 10:44:50.660
        int nanoseconds 973958435
</pre>
<p>No more output occurs because <b>outputValue</b> is now equal to <b>value</b>.
</p>
<p>Later in the tutorial there is a similar example except for channel <b>PVRsupportUByte</b>.
</p>
<h3>scripts</h3>
<p>The scripts all appear in:
</p>
<pre>
pwd
/home/epicsv4/masterCPP/exampleCPP/support/client/scripts
</pre>
<p>The scripts with names that start with config can be run either interactively
or via arguments.
The only exception is <b>configAll</b>
</p>

<h4>configControl</h4>
<p>
An example usage is:
</p>
<pre>
./configControl
recordName?
PVRsupportDouble
limitLow
-10
limitHigh
10
minStep
.5
Old : structure 
    control_t control
        double limitLow -10
        double limitHigh 10
        double minStep 0.5
        double outputValue 2.5
New : structure 
    control_t control
        double limitLow -10
        double limitHigh 10
        double minStep 0.5
        double outputValue 2.5
</pre>
<p>It could do the same without prompts via:
</p>
<pre>
./configControl PVRsupportDouble -10 10 .5
Old : structure 
    control_t control
        double limitLow -10
        double limitHigh 10
        double minStep 0.5
        double outputValue 10
New : structure 
    control_t control
        double limitLow -10
        double limitHigh 10
        double minStep 0.5
        double outputValue 10
</pre>
<p>The same could be done using pvput as follows:
</p>
<pre>
pvput -r "control" PVRsupportDouble control='{"limitLow":"-10","limitHigh":"10","minStep":".5"}'
</pre>

<h4>configScalarAlarm</h4>
<p>
An example usage is:
</p>
<pre>
./configScalarAlarm
recordName?
PVRsupportDouble
lowAlarmLimit
-8
lowWarningLimit
-6
highWarningLimit
6
highAlarmLimit
8
hysteresis
.1
Old : structure 
    scalarAlarm_t scalarAlarm
        double lowAlarmLimit -8
        double lowWarningLimit -6
        double highWarningLimit 6
        double highAlarmLimit 8
        double hysteresis 0.1
New : structure 
    scalarAlarm_t scalarAlarm
        double lowAlarmLimit -8
        double lowWarningLimit -6
        double highWarningLimit 6
        double highAlarmLimit 8
        double hysteresis 0.1
</pre>
<p>
Just like configControl it can be invoked by giving all values as arguments.
</p>
<h4>configProcessRecord</h4>
<p>example usage is:
</p>
<pre>
./configProcessRecord
processRecordName
PVRsupportProcessRecord
command?
remove
recordName?
PVRsupportDouble
// result is
PVRsupportProcessRecord
argument={"command":"remove","recordName":"PVRsupportDouble"}
Old : structure 
    structure argument
        string command add
        string recordName PVRsupportDouble
    structure result
        string status success
New : structure 
    structure argument
        string command remove
        string recordName PVRsupportDouble
    structure result
        string status success
</pre>
<p>It can also be invoked with arguments.</p>
<p>
The following also works:
</p>
<pre>
pvput -r "argument,result" PVRsupportProcessRecord argument='{"command":"add","recordName":"PVRsupportDouble"}'
Old : structure 
    structure argument
        string command add
        string recordName PVRsupportDouble
    structure result
        string status PVRsupportDouble already present
New : structure 
    structure argument
        string command add
        spwd
tring recordName PVRsupportDouble
    structure result
        string status PVRsupportDouble already present
</pre>
<h4>controlSigned</h4>
<p>
Convenience script for signed control limits.
</p>
<pre>
#!/bin/sh
./configControl PVRsupportDouble -10 10 .5
</pre>
<h4>controlUnsigned</h4>
<p>
Convenience script for unsigned control limits.
</p>
<pre>
#!/bin/sh
./configControl PVRsupportUByte 1 20 1
</pre>
<h4>scalarAlarmSigned</h4>
<p>
Convenience script for signed scalarAlarm limits.
</p>
<pre>
#!/bin/sh
./configScalarAlarm PVRsupportDouble -8 -6 6 8 .1
</pre>
<h4>scalarAlarmUnsigned</h4>
<p>
Convenience script for unsigned scalarAlarm limits.
</p>
<pre>
#!/bin/sh
./configScalarAlarm PVRsupportUByte 2 4 16 18 1
</pre>
<h4>configAll</h4>
<p>Use of this was shown above.</p>
<pre>
#!/bin/bash
./controlSigned
./scalarAlarmSigned
./controlUnsigned
./scalarAlarmUnsigned
./configProcessRecord PVRsupportProcessRecord add PVRsupportDouble
./configProcessRecord PVRsupportProcessRecord add PVRsupportUByte
./configProcessRecord PVRsupportProcessRecord add PVRsupportDouble
./configProcessRecord PVRsupportProcessRecord add PVRsupportUByte
</pre>

<h4>Support Examples</h4>
<p>Records PVRsupportDouble and PVRsupportUByte both use the <b>control</b>
and <b>scalarAlarm</b>
record support from pvDatabaseCPP.
</p>
<p>Previously there was an example accessing PVRsupportDouble.
Now lets look at an example accessing PVRsupportUByte.
</p>
<p>
After starting the database and running configAll, look at:
</p>
<pre>
pvget -r "control,scalarAlarm" PVRsupportUByte
PVRsupportUByte structure 
    control_t control
        double limitLow 1
        double limitHigh 20
        double minStep 1
        ubyte outputValue 0
    scalarAlarm_t scalarAlarm
        double lowAlarmLimit 2
        double lowWarningLimit 4
        double highWarningLimit 16
        double highAlarmLimit 18
        double hysteresis 1
</pre>
Look at the control and scalarAlarm settings.
<p>In one window:
</p>
<pre>
pvget -r "value,alarm,timeStamp,control.outputValue" -v -m PVRsupportUByte
</pre>
<p>Keep this window and see what happens when you run the following in another window:
</p>
<pre>
pvput PVRsupportUByte 40
</pre>
<p>In the first window you will see that <b>value</b> goes to 20 and the alarm changes.
It did NOT go to 40 because <b>control.limitHigh</b> is 20.
But <b>control.outputValue</b> changes by 1 each time the record processes.
On each process except the first only <b>timeStamp</b> and <b>control.outputValue</b>
change value.
This continues until <b>control.outputValue</b> is 20.
Then no more monitors occur.
</p>
<p>Now issue some more pvputs. For example to 19 then 15 then 5 then 0.
</p>

</div>
</body>
</html>
