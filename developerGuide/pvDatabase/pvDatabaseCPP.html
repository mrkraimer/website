<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
  <title>PvaClient</title>
  <link rel="stylesheet" type="text/css"
  href="../../css/base.css" />
  <link rel="stylesheet" type="text/css"
  href="../../css/epicsv4.css" />
  <style type="text/css">
  /*<![CDATA[*/
     .about { margin-left: 3em; margin-right: 3em; font-size: .83em}
     table { margin-left: auto; margin-right: auto }
     .diagram { text-align: center; margin: 2.5em 0 }
     span.opt { color: grey }
     span.nterm { font-style:italic }
     span.term { font-family:courier }
     span.user { font-family:courier }
     span.user:before { content:"<" }
     span.user:after { content:">" }
     .nonnorm { font-style:italic }
     p.ed { color: #AA0000 }
     span.ed { color: #AA0000 }
     p.ed.priv { display: inline; }
     span.ed.priv { display: inline; }
  /*]]>*/</style>
  <!-- Script that generates the Table of Contents -->
  <script type="text/javascript"
  src="../../css/tocgen.js">
  </script>
</head>

<body>

<div class="head">
<h1>pvDatabaseCPP</h1>
<h2 class="nocount">editions</h2>
<dl>
  <dt>2021.03.01</dt>
     <dd>Original</dd>
  <dt>2021.04.23</dt>
     <dd>Update</dd>
</dl>  
<dl>
  <dt>Editors:</dt>
    <dd>Marty Kraimer</dd>
</dl>
<p>This product is available via an <a
href="../../LICENSE">open source license
</a></p>

</div>

<div id="toc">
<h2 class="nocount" style="page-break-before: always">Table of Contents</h2>
</div>

<div id="contents" class="contents">

<h2>Overview</h2>
<p>
This document is the guide for pvDatabaseCPP, which is one of the components of
<a href="https://epics-controls.org/resources-and-support/base/epics-7/">
EPICS-7
</a>
</p>

<p>Doxgen for pvDatabase is located at:
<a
href="./html/index.html">doxygen
</a>.
</p>

<p><b>pvDatabase</b> is a framework for implementing a network accessible database of smart memory resident
records.
</p>
<p>
This document is intended for anyone creating new PVRecords.
<a
href="../pvService/pvService.html">pvService
</a>
Describes a good way to create services via PVRecords.
</p>
<h4>PVDatabase Components</h4>
<p><b>pvDatabase</b> has the following components:
</p>
<dl>
<dt>database</dt>
<dd>
The most important components are:
<dl>
    <dt>PVRecord</dt>
      <dd>
      This is a record. It has a <b>PVStructure</b> and a method <b>process</b>, which is what makes it smart.
      </dd>
    <dt>PVDatabase</dt>
      <dd>
      The is a database of PVRecords.
      </dd>
</dl>
</dd>

<dt>pvAccess</dt>
<dd>
This has the following:
<dl>
    <dt>ChannelProviderLocal</dt>
      <dd>
      This a ChannelProvider, defined in pvAccess, that provides access to the PVDatabse records.
      </dd>
    <dt>ChannelLocal</dt>
      <dd>
      This provides access to a single PVRecord.
      </dd>  
</dl>
</dd>

<dt>copy</dt>
<dd>
This has the code for pvStructureCopy and all the plugin support.
</dd>

<dt>special</dt>
   <dd>
   PVRecords that can be created by pvDatabase itself.
   A record can be created directly by a client or via iocshell commands.
   </dd>
<dt>support</dt>
   <dd>deprecated</dd>
</dl>

<h2>database</h2>
<p>
This is the code for creating a PVDatabase, which is a database of PVRecords.
</p>
<h3>PVRecord</h3>
<p>
A PVRecord consists of a PVStructure and a set of methods for accessing the record.
The PVStructure has the data for the record.
There is a base class that implements all the methods associated with accessing the record.
But some are virtual and can be implemented by a derived class.
</p>
<p>The virtual methods are:</p>
<dl>
   <dt>process</dt>
   <dd>
   This is the method that makes a record smart.
   Often this is the only method a derived class needs to implement.
   If it encounters errors it should raise alarms and/or
   call the <b>message</b> method provided by the base class.
   If the pvStructure has a top level timeStamp,
   the base class sets the timeStamp to the current time.
   </dd>
   <dt>init</dt>
   <dd>
   A derived class can implement this if finds errors during initilization
   and does not want the record added to the PVDatabase.
   </dd>
   <dt>start</dt>
   <dd>
   This is called before record is added to database.
   </dd>
   <dt>remove</dt>
   <dd>
   Remove the PVRecord. Release any resources used and
   get rid of listeners and requesters.
   If derived class overrides this then it must call PVRecord::remove()
   after it has destroyed any resorces it uses.
   </dd>
   <dt>getService</dt>
   <dd>
   Return a service corresponding to the specified request PVStructure.
   </dd>
</dl>
<p><b>ChannelProviderLocal</b>, described below, allows client to access a record
via the network.
But another record in the same ioc can access the record via the PVDatabase.
For example if the other record wants to put data into the record it must do something like the following:
</p>
<pre>
PVRecordPtr pvr(pvRecord.lock());
if(!pvr) throw std::logic_error("pvRecord is deleted");
try {
    {
        epicsGuard&lt;PVRecord&gt; guard(*pvr);
        pvr->beginGroupPut();
        // put data
        pvr->process();
        pvr->endGroupPut();
    }
} catch(std::exception&amp; ex) {
        // handle error
}
</pre>
<h4>method brief description</h4>
<pre>
The following are virtual methods.
init                 Initialization method.
start                Called before a record is added to database.
process              Process the record.
remove               Remove the PVRecord.
getService           Return a service corresponding to the specified request PVStructure.

The following are implemented by the base class.
create               Create a soft record.
getRecordName        Get the record name.
getPVStructure       Get the PVStructure for the record.
getPVRecordStructure Get the PVRecordStrucure.
findPVRecordField    Find a PVRecordField
lock                 Lock the record. No other code can access the record until unlock
unlock               Unlock the record.
tryLock              Try to lock the record.
lockOtherRecord      Client holding lock can lock one other record.
addPVRecordClient    Every client that accesses the record can call this
                     so that the client can be notified when the record is deleted.
addListener          This must be called before calling pvRecordField.addListener.
nextMasterPVField    PVCopyTraverseMasterCallback method.
removeListener       Remove a listener.
beginGroupPut        Begins a group of puts.
endGroupPut          Ends a group of puts.
getTraceLevel        Get trace level (0,1,2) means (nothing,lifetime,process)
setTraceLevel        Set trace level (0,1,2) means (nothing,lifetime,process)
getAsLevel           Get the AS level.
getAsGroup           Get the AS group name.
setAsLevel           Set access security level.
setAsGroup           Set access security group.
</pre>
<h3>PVRecordStructure</h3>
<p><b>PVRecordStructure</b> has methods:</p>
<pre>
getPVRecordFields    Get the sub fields.
getPVStructure       Get the PVStructure.
</pre>
<h3>PVRecordField</h3>
<p><b>PVRecordField</b> has methods:</p>
<pre>
getParent            Get the PVRecordStructure.
getPVField           Get the PVField.
getFullFieldName     Get the full field name.
getFullName          Get the recordName plus the full name of the field.
getPVRecord          Get the PVRecord to which this field belongs.
postPut              This is called by the code that implements the data interface.
                     It is called whenever the put method is called.
</pre>
<h3>PVRecordClient</h3>
<p><b>PVRecordClient</b> has methods:</p>
<pre>
detach  Detach from the record because it is being removed.
</pre>
<h3>PVListener</h3>
<p><b>PVListener</b> has methods:</p>
<pre>
dataPut        This is called if the listener has called PVRecordField::addListener for pvRecordField.
beginGroupPut  Begin a set of puts.
endGroupPut    End a set of puts.
unlisten       Connection to record is being terminated.
</pre>
<h3>PVDatabase</h3>
<p><b>PVDatabase</b> has methods:</p>
<pre>
findRecord       Find a record in the database.
addRecord        Add a record to the database.
removeRecord     Remove a record from the database.
getRecordNames   Get the names of all the records in the database.
getMaster        Get the master database. This is what clients access.
</pre>

<h2>pvAccess</h2>
<p>This code provides the ability for a pvAccess client to  communicate with PVRecords.
<b>qsrv</b> is the server side of pvAccess that provides access to an IOC.
</p>
<p>
The pvAccess component of pvDatabase implements a provider named local and registers it
with <b>qsrv</b>
</p>

<h3>ChannelProviderLocal</h3>
<p><b>ChannelProviderLocal</b> has methods:</p>
<pre>
initAs             Initialize access security configuration.
isAsActive         Is access security active.
getProviderName    Returns the channel provider name.
channelFind        Returns either a null channelFind or a channelFind for records in the PVDatabase.
channelList        Provide the caller with a list of the record names on the PVDatabase.
createChannel      Create a channel for a record.
getTraceLevel      Get trace level (0,1,2) means (nothing,lifetime,process)
setTraceLevel      Set trace level (0,1,2) means (nothing,lifetime,process)
getChannelProvider Get the channel provider.
</pre>
<h3>ChannelLocal</h3>
<p><b>ChannelLocal</b> has methods:</p>
<pre>
detach               This is called when a record is being removed from the database, 
getRequesterName     Get the requester name.
message              Passes the message to the channel requester.
getProvider          Get the channel provider.
getRemoteAddress     Get the remote address.
getConnectionState   Get the connection state.
getChannelName       Get the channel name.
getChannelRequester  Get the channel requester.
isConnected          Is the channel connected?
getField             Get the introspection interface for a subField.
getAccessRights      Get the access rights for the record.
createChannelProcess Create a channelProcess.
createChannelGet     Create a channelGet.
createChannelPut     Create a channelPut.
createChannelPutGet  Create a channelPutGet.
createChannelRPC     Create a channelRPC
                     The PVRecord must implement <b>getService</b> or an empty shared pointer is returned.
createMonitor        Create a Monitor
createChannelArray   Create a channelArray.
printInfo            Displays a message.
canWrite             Can the client write to the record.
canRead              Can the client read from the record.
</pre>

<h2>copy</h2>
<h3>PVPlugin</h3>
<p><b>PVPlugin</b> has methods:</p>
<pre>
create               Creates a plugin filter
</pre>
<h3>PVPluginRegistry</h3>
<p><b>PVPluginRegistry</b> has methods:</p>
<pre>
registerPlugin       Register a plugin.
find                 Find a plugin.
</pre>
<h3>PVFilter</h3>
<p><b>PVFilter</b> has methods:</p>
<pre>
filter       Update copy or master
getName      Get the filter name.
</pre>
<h3>PVArrayPlugin</h3>
<p><b>PVArrayPlugin</b> has methods:</p>
<pre>
create       Create a PVArrayFilter
</pre>
<h3>PVArrayFilter</h3>
<p><b>PVArrayFilter</b> has methods:</p>
<pre>
create      Create an array filter
filter      Perform a filter operation.
getName     Get the filter name.
</pre>
<h3>PVDeadbandPlugin</h3>
<p><b>PVDeadbandPlugin</b> has methods:</p>
<pre>
create      Create a PVDeadbandFilter
</pre>
<h3>PVDeadbandFilter</h3>
<p><b>PVDeadbandFilter</b> has methods:</p>
<pre>
create      Create a deadband filter  
filter      Perform a filter operation.
getName     Get the filter name.
</pre>
<h3>PVTimestampPlugin</h3>
<p><b>PVTimestampPlugin</b> has methods:</p>
<pre>
create    A plugin for a filter that sets a timeStamp to the current time
</pre>
<h3>PVTimestampFilter</h3>
<p><b>PVTimestampFilter</b> has methods:</p>
<pre>
create      Create a timeStamp filter
filter      Perform a filter operation.
getName     Get the filter name.
</pre>

</div>
</body>
</html>
