<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1" />
  <title>PvaClient</title>
  <link rel="stylesheet" type="text/css"
  href="../../css/base.css" />
  <link rel="stylesheet" type="text/css"
  href="../../css/epicsv4.css" />
  <style type="text/css">
  /*<![CDATA[*/
     .about { margin-left: 3em; margin-right: 3em; font-size: .83em}
     table { margin-left: auto; margin-right: auto }
     .diagram { text-align: center; margin: 2.5em 0 }
     span.opt { color: grey }
     span.nterm { font-style:italic }
     span.term { font-family:courier }
     span.user { font-family:courier }
     span.user:before { content:"<" }
     span.user:after { content:">" }
     .nonnorm { font-style:italic }
     p.ed { color: #AA0000 }
     span.ed { color: #AA0000 }
     p.ed.priv { display: inline; }
     span.ed.priv { display: inline; }
  /*]]>*/</style>
  <!-- Script that generates the Table of Contents -->
  <script type="text/javascript"
  src="../../css/tocgen.js">
  </script>
</head>

<body>

<div class="head">
<h1>pvDatabaseCPP</h1>
<h2 class="nocount">March 2021</h2>
<dl>
  <dt>Editors:</dt>
    <dd>Marty Kraimer</dd>
</dl>
<h2 class="nocount">Work is Progress; Making Progress!!</h2>
<p>This product is available via an <a
href="../../LICENSE">open source license
</a></p>

</div>

<div id="toc">
<h2 class="nocount" style="page-break-before: always">Table of Contents</h2>
</div>

<div id="contents" class="contents">

<h2>Overview</h2>
<p>
This document is the guide for pvDatabaseCPP, which is one of the components of
<a href="https://epics-controls.org/resources-and-support/base/epics-7/">
EPICS-7
</a>
</p>

<p>Doxgen for pvDatabase is located at:
<a
href="./html/index.html">doxygen
</a>.
</p>

<p><b>pvDatabase</b> is a framework for implementing a network accessible database of smart memory resident
records.
</p>
<p>
This document is intended for the following:
</p>
<h4>Users</h4>
<p>Anyone who starts epics IOCS that has support for PVRecords.
If this is the only interest then only the section about "iocshell commands" is required reading.
</p>
<h4>PVRecord Developers</h4>
This is anyone creating new PVRecords.
The sections "exampleCPP", and "database" are suggested reading, especially "PVRecord".
Also of interest are:
<p>
<a
href="../recordSupport/recordSupport.html">recordSupport
</a>
Descibes support that can be attached to a PVRecord.
</p>
<p>
<a
href="../pluginSupport/pluginSupport.html">pluginSupport
</a>
Description of the plugin filter support implemented by pvDatabase.
</p>
<p>
<a
href="../specialRecord/specialRecord.html">specialRecord
</a>
A description of the <b>dbprcr*</b>Records.
</p>

<h4>Hard Core Geeks</h4>
<p>This entire document</p>

<h4>PVDatabase Components</h4>
<p><b>pvDatabase</b> has the following components:
</p>

<dl>
<dt>iocshell commands</dt>
<dd>
This show commands that can be issued from the iocshell.
</dd>

<dt>exampleCPP</dt>
<dd>
This briefly describes examples that may be of interest to developers that want to create PVRecords.
</dd>

<dt>database</dt>
<dd>
The most important components are:
<dl>
    <dt>PVRecord</dt>
      <dd>
      This is a record. It has a <b>PVStructure</b> and a method <b>process</b>, which is what makes it smart.
      </dd>
    <dt>PVDatabase</dt>
      <dd>
      The is a database of PVRecords.
      </dd>
</dl>
</dd>

<dt>pvAccess</dt>
<dd>
This has the following:
<dl>
    <dt>ChannelProviderLocal</dt>
      <dd>
      This a ChannelProvider, defined in pvAccess, that provides access to the PVDatabse records.
      </dd>
    <dt>ChannelLocal</dt>
      <dd>
      This provides access to a single PVRecord.
      </dd>  
</dl>
</dd>

<dt>copy</dt>
<dd>
This has the code for pvStructureCopy and all the plugin support.
</dd>
</dl>

<h2>iocshell commands</h2>
<p>Shell commands are made available via the standard DBD include mechanism
provided by iocCore.
The following provide PVDatbase shell commands:</p>
<pre>
pvAccessCPP
qsrv
pvDatabaseCPP
pvdbSpecialRegister.dbd
</pre>

<p>pvDatabaseCPP provides the following iocshell command.</p>
<dl>
   <dt>registerChannelProviderLocal</dt>
     <dd>Including <b>registerChannelProviderLocal.dbd</b> as a dbd file automatically starts provider local
      and also creates the pvdbl shell command.
     </dd>
   <dt>pvdbl</dt>
      <dd>Provides a list of all the pvRecords in database <b>master</b>
      </dd>
</dl>
<p><b>pvdbSpecialRegister.dbd</b> provides access to the following commands implemted in 
<b>src/special</b>
This provides the ability to create the following records:
</p>
<dl>
    <dt>pvdbcrScalar</dt>
      <dd>
      Create a soft record with the value field having one of the scalar types.
      </dd>
    <dt>pvdbcrScalarArray</dt>
      <dd>
      Create a soft record with the value field being an array of one of the scalar types.
      </dd>
    <dt>pvdbcrAddRecord</dt>
      <dd>
      Create a record that adds a new soft record.
      </dd>
    <dt>pvdbcrRemoveRecord</dt>
      <dd>
      Create a record that removes a record from that database.
      </dd>
    <dt>pvdbcrProcessRecord</dt>
      <dd>
      Create a record that processes another record.
      </dd>
    <dt>pvdbcrTraceRecord</dt>
      <dd>
      Create a record that sets the trace level for another record.
      </dd>
            
</dl>
<p>Note that all start with <b>pvdbcr</b>.
which stands for pvdatabase create record.
</p>
<p>In addition any code that implements a PVRecord must implement an iocshell command.
Look at the examples in <b>exampleCPP</b> to see how to implement shell commands.</p>

<h2>exampleCPP</h2>
<p>Example code is available at:
<a
href="https://github.com/epics-base/exampleCPP">
exampleCPP
</a>
</p>
<p>In particular look at the example code mentioned in the following sub-sections.
</p>

<h3>database</h3>
<p>This has many examples of how to create both soft records and records that implement
other functionality.</p>
<dl>
   <dt>exampleDatabase.cpp</dt>
     <dd>
      This shows how to create soft records of each pvData type.<br />
      In addition shows how to create instances of the following two records.
     </dd>
   <dt>exampleHelloRecord.cpp</dt>
     <dd>
       This is a simple "hello world" that is intentended to be used via a channelPutGet request.
     </dd>
   <dt>exampleHelloRPC.cpp</dt>
     <dd>
       This is a simple "hello world" that is intentended to be used via a channelRPC request.
     </dd>
   <dt>exampleDatabaseMain.cpp</dt>
     <dd>
      This shows how to create a standalone IOC.
     </dd>
   <dt>ioc and iocBoot</dt>
     <dd>
      This has code and examples to create a V3 IOC which also has a PVDatabase.
     </dd>
</dl>
<h3>exampleLink</h3>
<p>This shows how to implement a record that has a link to another record</p>
<dl>
  <dt>getLinkScalar</dt>
     <dd>
      This creates a get link to a record that has a scalar value field.
     </dd>
  <dt>getLinkScalarArray</dt>
     <dd>
      This creates a get link to a record that has a scalarArray value field.
     </dd>
  <dt>putLinkScalar</dt>
     <dd>
      This creates a put link to a record that has a scalar value field.
     </dd>
  <dt>putLinkScalar</dt>
     <dd>
      This creates a put link to a record that has a scalar array value field.
     </dd>     
</dl>
<p>
Each can access the linked record either via pvaClient or by directly accessing the PVDatabase.
</p>

<h3>support</h3>
<p>This creates records that have the following features:</p>
<dl>
   <dt>value</dt>
   <dd>
    Each record has a value field the is a numeric scalar field.
    In addition each has the following fields:
    alarm,timeStamp,control,scalarAlarm, and display.
   </dd>
   <dt>support</dt>
   <dd>
     Each record uses the control and scalarAlarm support provided by pvDatabaseCPP.
   </dd>
</dl>
<p>
It also creates records that can be used by clients to show example of the plugin support.
</p>


<h2>database</h2>
<p>
This is the code for creating a PVDatabase, which is a database of PVRecords.
</p>
<h3>PVRecord</h3>
<p>
A PVRecord consists of a PVStructure and a set of methods for accessing the record.
The PVStructure has the data for the record.
There is a base class that implements all the methods associated with accessing the record.
But some are virtual and can be implemented by a derived class.
</p>
<p>The virtual methods are:</p>
<dl>
   <dt>process</dt>
   <dd>
   This is the method that makes a record smart.
   Often this is the only method a derived class needs to implement.
   If it encounters errors it should raise alarms and/or
   call the <b>message</b> method provided by the base class.
   If the pvStructure has a top level timeStamp,
   the base class sets the timeStamp to the current time.
   </dd>
   <dt>init</dt>
   <dd>
   A derived class can implement this if finds errors during initilization
   and does not want the record added to the PVDatabase.
   </dd>
   <dt>start</dt>
   <dd>
   This is called before record is added to database.
   </dd>
   <dt>remove</dt>
   <dd>
   Remove the PVRecord. Release any resources used and
   get rid of listeners and requesters.
   If derived class overrides this then it must call PVRecord::remove()
   after it has destroyed any resorces it uses.
   </dd>
   <dt>getService</dt>
   <dd>
   Return a service corresponding to the specified request PVStructure.
   </dd>
</dl>
<p><b>ChannelProviderLocal</b>, described below, allows client to access a record
via the network.
But another record in the same ioc can access the record via the PVDatabase.
For example if the other record wants to put data into the record it must do something like the following:
</p>
<pre>
PVRecordPtr pvr(pvRecord.lock());
if(!pvr) throw std::logic_error("pvRecord is deleted");
try {
    {
        epicsGuard&lt;PVRecord&gt; guard(*pvr);
        pvr->beginGroupPut();
        // put data
        pvr->process();
        pvr->endGroupPut();
    }
} catch(std::exception&amp; ex) {
        // handle error
}
</pre>
<h4>method brief description</h4>
<pre>
The following are virtual methods.
init                 Initialization method.
start                Called before a record is added to database.
process              Process the record.
remove               Remove the PVRecord.
getService           Return a service corresponding to the specified request PVStructure.

The following are implemented by the base class.
create               Create a soft record.
getRecordName        Get the record name.
getPVStructure       Get the PVStructure for the record.
getPVRecordStructure Get the PVRecordStrucure.
findPVRecordField    Find a PVRecordField
lock                 Lock the record. No other code can access the record until unlock
unlock               Unlock the record.
tryLock              Try to lock the record.
lockOtherRecord      Client holding lock can lock one other record.
addPVRecordClient    Every client that accesses the record can call this
                     so that the client can be notified when the record is deleted.
addListener          This must be called before calling pvRecordField.addListener.
nextMasterPVField    PVCopyTraverseMasterCallback method.
removeListener       Remove a listener.
beginGroupPut        Begins a group of puts.
endGroupPut          Ends a group of puts.
getTraceLevel        Get trace level (0,1,2) means (nothing,lifetime,process)
setTraceLevel        Set trace level (0,1,2) means (nothing,lifetime,process)
getAsLevel           Get the AS level.
getAsGroup           Get the AS group name.
setAsLevel           Set access security level.
setAsGroup           Set access security group.
</pre>
<h3>PVRecordStructure</h3>
<p><b>PVRecordStructure</b> has methods:</p>
<pre>
getPVRecordFields    Get the sub fields.
getPVStructure       Get the PVStructure.
</pre>
<h3>PVRecordField</h3>
<p><b>PVRecordField</b> has methods:</p>
<pre>
getParent            Get the PVRecordStructure.
getPVField           Get the PVField.
getFullFieldName     Get the full field name.
getFullName          Get the recordName plus the full name of the field.
getPVRecord          Get the PVRecord to which this field belongs.
postPut              This is called by the code that implements the data interface.
                     It is called whenever the put method is called.
</pre>
<h3>PVRecordClient</h3>
<p><b>PVRecordClient</b> has methods:</p>
<pre>
detach  Detach from the record because it is being removed.
</pre>
<h3>PVListener</h3>
<p><b>PVListener</b> has methods:</p>
<pre>
dataPut        This is called if the listener has called PVRecordField::addListener for pvRecordField.
beginGroupPut  Begin a set of puts.
endGroupPut    End a set of puts.
unlisten       Connection to record is being terminated.
</pre>
<h3>PVDatabase</h3>
<p><b>PVDatabase</b> has methods:</p>
<pre>
findRecord       Find a record in the database.
addRecord        Add a record to the database.
removeRecord     Remove a record from the database.
getRecordNames   Get the names of all the records in the database.
getMaster        Get the master database. This is what clients access.
</pre>

<h2>pvAccess</h2>
<p>This code provides the ability for a pvAccess client to  communicate with PVRecords.
<b>qsrv</b> is the server side of pvAccess that provides access to an IOC.
</p>
<p>
The pvAccess component of pvDatabase implements a provider named local and registers it
with <b>qsrv</b>
</p>

<h3>ChannelProviderLocal</h3>
<p><b>ChannelProviderLocal</b> has methods:</p>
<pre>
initAs             Initialize access security configuration.
isAsActive         Is access security active.
getProviderName    Returns the channel provider name.
channelFind        Returns either a null channelFind or a channelFind for records in the PVDatabase.
channelList        Provide the caller with a list of the record names on the PVDatabase.
createChannel      Create a channel for a record.
getTraceLevel      Get trace level (0,1,2) means (nothing,lifetime,process)
setTraceLevel      Set trace level (0,1,2) means (nothing,lifetime,process)
getChannelProvider Get the channel provider.
</pre>
<h3>ChannelLocal</h3>
<p><b>ChannelLocal</b> has methods:</p>
<pre>
detach               This is called when a record is being removed from the database, 
getRequesterName     Get the requester name.
message              Passes the message to the channel requester.
getProvider          Get the channel provider.
getRemoteAddress     Get the remote address.
getConnectionState   Get the connection state.
getChannelName       Get the channel name.
getChannelRequester  Get the channel requester.
isConnected          Is the channel connected?
getField             Get the introspection interface for a subField.
getAccessRights      Get the access rights for the record.
createChannelProcess Create a channelProcess.
createChannelGet     Create a channelGet.
createChannelPut     Create a channelPut.
createChannelPutGet  Create a channelPutGet.
createChannelRPC     Create a channelRPC
                     The PVRecord must implement <b>getService</b> or an empty shared pointer is returned.
createMonitor        Create a Monitor
createChannelArray   Create a channelArray.
printInfo            Displays a message.
canWrite             Can the client write to the record.
canRead              Can the client read from the record.
</pre>

<h2>copy</h2>
<h3>PVPlugin</h3>
<p><b>PVPlugin</b> has methods:</p>
<pre>
create
</pre>
<h3>PVPluginRegistry</h3>
<p><b>PVPluginRegistry</b> has methods:</p>
<pre>
registerPlugin
find
</pre>
<h3>PVFilter</h3>
<p><b>PVFilter</b> has methods:</p>
<pre>
filter
getName
</pre>
<h3>PVArrayPlugin</h3>
<p><b>PVArrayPlugin</b> has methods:</p>
<pre>
create
</pre>
<h3>PVArrayFilter</h3>
<p><b>PVArrayFilter</b> has methods:</p>
<pre>
create
filter
getName
</pre>
<h3>PVDeadbandPlugin</h3>
<p><b>PVDeadbandPlugin</b> has methods:</p>
<pre>
create
</pre>
<h3>PVDeadbandFilter</h3>
<p><b>PVDeadbandFilter</b> has methods:</p>
<pre>
create
filter
getName
</pre>
<h3>PVTimestampPlugin</h3>
<p><b>PVTimestampPlugin</b> has methods:</p>
<pre>
create
</pre>
<h3>PVTimestampFilter</h3>
<p><b>PVTimestampFilter</b> has methods:</p>
<pre>
create
filter
getName
</pre>


</div>
</body>
</html>
